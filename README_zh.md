# é€‚ç”¨äº DETR è®­ç»ƒçš„ GPU æ‰¹é‡å¹¶è¡ŒåŠ é€Ÿçš„åŒˆç‰™åˆ©ç®—æ³•

æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ªåŒˆç‰™åˆ©ç®—æ³•çš„ **CUDA/C++ é«˜æ•ˆå®ç°æ–¹æ¡ˆ**ã€‚å®ƒèƒ½ä¸ PyTorch æ— ç¼é›†æˆï¼Œä¸“ä¸ºæ‰¹é‡çš„ 300 Ã— Nï¼ˆN â‰¤ 300ï¼‰æŒ‡æ´¾é—®é¢˜è€Œä¼˜åŒ–è®¾è®¡çš„â€”â€”è¿™ç±»é—®é¢˜å¸¸è§äº **DETR** åŠç›¸å…³æ¨¡å‹çš„è®­ç»ƒè¿‡ç¨‹ä¸­ã€‚

ç›¸æ¯”å¹¿æ³›ä½¿ç”¨çš„åŸºäº CPU çš„ SciPy `linear_sum_assignment`ï¼Œæœ¬å®ç°æ–¹æ¡ˆåœ¨éšæœºè¾“å…¥ä¸‹å¯å®ç° **8~160 å€çš„åŠ é€Ÿæ¯”**ï¼Œåœ¨å®é™… DETR è®­ç»ƒåœºæ™¯ä¸­å®ç° **3~10 å€çš„åŠ é€Ÿæ¯”**ï¼ˆæµ‹è¯•è®¾å¤‡ä¸º **NVIDIA RTX 4090 GPU**ï¼‰ã€‚

---

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- æ”¯æŒå½¢çŠ¶ä¸º [B Ã— 300 Ã— N] çš„æ‰¹é‡æŒ‡æ´¾é—®é¢˜
  - æ¯ä¸ªä»£ä»·çŸ©é˜µçš„æœ€å¤§å°ºå¯¸å¯é€šè¿‡ç¼–è¯‘å‰ä¿®æ”¹ CUDA æºç ä¸­çš„ `MAX_ROWS` å’Œ `MAX_COLS` è¿›è¡Œè°ƒæ•´
  - æ¯ä¸ªä»£ä»·çŸ©é˜µå¯ä»¥æœ‰ä¸åŒå°ºå¯¸ï¼›åœ¨å †å å‰ç”¨ INF å€¼å¡«å……è‡³ Nï¼ˆN â‰¤ 300ï¼‰
  - ä»£ä»·çŸ©é˜µçš„æ•°æ®ç±»å‹ä¸º `torch.float32`

- åŒˆç‰™åˆ©ç®—æ³•çš„ GPU å¹¶è¡Œå®ç°åŒ…æ‹¬ï¼š
  - å¯¹å¶å˜é‡åˆå§‹åŒ–
  - ä½¿ç”¨ warp çº§è§„çº¦çš„ Î” æœ€å°å€¼æœç´¢
  - æ½œåœ¨å€¼æ›´æ–°ï¼ˆu, v, minvï¼‰
  - æœ€ç»ˆåŒ¹é…åŠç»“æœå†™å‡º

- åœ¨ä»¥ä¸‹æ–¹é¢ä¸ SciPy `linear_sum_assignment` çš„è¿›è¡Œå¯¹æ¯”éªŒè¯ï¼š
  - æ­£ç¡®æ€§
  - è¿è¡Œæ•ˆç‡

---

## ğŸ“¦ ç¯å¢ƒä¾èµ–

- Python 3.x
- PyTorch â‰¥ 2.0ï¼ˆéœ€æ”¯æŒ `torch.utils.cpp_extension`ï¼‰
- NVIDIA é©±åŠ¨ â‰¥ 535
- CUDA â‰¥ 12.2ï¼ˆæ—©æœŸç‰ˆæœ¬å¯èƒ½ä¹Ÿå¯è¿è¡Œï¼‰
- æ”¯æŒ C++17 çš„ç¼–è¯‘å™¨åŠ NVCC

> æµ‹è¯•å¹³å°ï¼šNVIDIA RTX 4090 GPU

---

## âš™ï¸ ä½¿ç”¨æ–¹æ³•

**1. è¿è¡Œç¤ºä¾‹è„šæœ¬**

```bash
python hungarian_gpu_batch.py
```

è¯¥è„šæœ¬å°†ï¼š
- åœ¨çº¿ç¼–è¯‘ CUDA/C++ æ‰©å±•
- ä½¿ç”¨éšæœºä»£ä»·çŸ©é˜µè¿›è¡Œæµ‹è¯•
- å¯¹æ¯” GPU å’Œ SciPy CPU çš„ç»“æœ
- è¾“å‡ºè¿è¡Œæ—¶é—´å’ŒåŠ é€Ÿæ¯”ç»Ÿè®¡

ä½ å°†çœ‹åˆ°æ¯æ¬¡æµ‹è¯•çš„æ€§èƒ½æ—¥å¿—ï¼Œéšåæ˜¯æœ€å 10 æ¬¡æµ‹è¯•çš„å¹³å‡ç»Ÿè®¡ç»“æœã€‚ä¾‹å¦‚è¾“å‡ºï¼š

```log
Mean valid ncols in cost matrix: 203.75
GPU runtime      :    3.85 ms
SciPy CPU runtime:   32.69 ms
Speed-up         :    8.50 x

Mean valid ncols in cost matrix: 164.62
GPU runtime      :    3.23 ms
SciPy CPU runtime:   29.52 ms
Speed-up         :    9.13 x

...
...

Average of the last 10 Loops
GPU runtime      :    1.49 ms
SciPy CPU runtime:   24.67 ms
Speed-up         :   20.67 x
```

**2. åœ¨ä½ è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨**

ç®€å•ç¤ºä¾‹ï¼š

```python
import torch
from hungarian_gpu_batch import hungarian_gpu

cost = torch.rand((16, 300, 300), device="cuda", dtype=torch.float32)  # æ‰¹é‡ä»£ä»·çŸ©é˜µ
Ns = torch.randint(1, 301, (16,), device="cuda", dtype=torch.int32)    # æ‰¹é‡å®é™…ä»»åŠ¡æ•°ï¼Œæ¯ä¸ª Ni å¯¹åº”ä¸€ä¸ªä»£ä»·çŸ©é˜µï¼ˆè¶…è¿‡ Ni çš„æ¡ç›®å°†è¢«å¿½ç•¥ï¼‰

output = hungarian_gpu(cost, Ns)
```

---

## ğŸ“Š æ€§èƒ½è¡¨ç°

**1. éšæœºæµ‹è¯•**

æˆ‘ä»¬å±•ç¤ºäº†åœ¨ä¸åŒæ‰¹é‡å¤§å° (B) ä¸‹çš„åŠ é€Ÿæ›²çº¿ï¼Œè¾“å…¥ä¸ºéšæœºå¡«å……çš„ [B Ã— 300 Ã— 300] ä»£ä»·çŸ©é˜µã€‚å®éªŒå‡åœ¨å•å¼  NVIDIA RTX 4090 GPU ä¸Šè¿›è¡Œã€‚

> å¯¹æ¯”åŸºå‡†: SciPy `linear_sum_assignment`

<img src="https://github.com/linfeng93/HA4DETR/blob/main/speedup.png" style="width:70%; height:auto;">

**2. å®é™…åº”ç”¨**

æˆ‘ä»¬å°†è¯¥ GPU ç‰ˆåŒˆç‰™åˆ©ç®—æ³•é›†æˆè‡³ DETR è®­ç»ƒæµç¨‹ï¼Œæ›¿æ¢åŸæœ‰ SciPy çš„ `linear_sum_assignment`ã€‚

åœ¨æ¯å¼  GPU ä¸Šçš„ batch size ä¸º 16ï¼ˆæ¯å¼  GPU å¤„ç†è‡ªå·±çš„æ ·æœ¬ï¼‰æ—¶ï¼Œè¯¥å®ç°å¸¦æ¥äº† **3 å€åŠ é€Ÿ**ï¼Œæ•´ä½“è®­ç»ƒå¼€é”€å‡å°‘äº†çº¦ **10%**ã€‚éšç€ batch size çš„å¢å¤§ï¼ŒåŠ é€Ÿæ•ˆæœä¼šæ›´ä¸ºæ˜¾è‘—ï¼Œè¿™ä¸éšæœºæµ‹è¯•ä¸­è§‚å¯Ÿåˆ°çš„è¶‹åŠ¿ä¸€è‡´ã€‚

---

## ğŸ“œ è®¸å¯è¯

æœ¬ä»“åº“åŸºäº [Apache-2.0 åè®®](https://github.com/linfeng93/HA4DETR/blob/main/LICENSE) è¿›è¡Œæˆæƒã€‚

---

## ğŸ“š å¼•ç”¨æ–¹å¼

å¦‚æœä½ è§‰å¾—è¿™ä¸ªä»“åº“æœ‰ç”¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹ BibTeX è¿›è¡Œå¼•ç”¨ï¼š

```bibtex
@misc{ha4detr,
    title = {GPU-Accelerated Batched Hungarian Algorithm for DETR},
    author = {Feng Lin, Xiaotian Yu, Rong Xiao},
    year = {2025},
    publisher = {GitHub},
    url = {https://github.com/linfeng93/HA4DETR},
}
```

---

## ğŸ’¼ é¸£è°¢

æœ¬å¼€æºä»“åº“èµ·æºäº **Intellifusion Inc.** çš„è§†é¢‘ç›®æ ‡æ£€æµ‹é¡¹ç›®ï¼Œç”± Feng Linã€Xiaotian Yu å’Œ Rong Xiao å…±åŒå¼€å‘ã€‚

---

## ğŸ“® è”ç³»æ–¹å¼

æ¬¢è¿é€šè¿‡ issue æˆ– PR å‚ä¸è®¨è®ºã€æå‡ºå»ºè®®æˆ–æé—®ã€‚
